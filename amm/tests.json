[
    "# Run this script:./amm_tester.py ./tests.json",
    "# Runs on ammdevnet. Change next line to run on a different net.",
    "#set node ammdevnet:51234",
    "set wait 6",
    "#",
    "# fund",
    "#",
    "fund gw,alice,carol,bob,dan,A1,A2,A3,A4,A5,A6,A7,A8,A9 40000XRP",
    "trust set alice,carol,bob,dan,A1,A2,A3,A4,A5,A6,A7,A8,A9 60000USD gw",
    "trust set alice,carol,bob,dan 60000EUR gw",
    "trust set alice,carol,bob,dan 60000GBP gw",
    "trust set alice,carol,bob,dan 60000BTC gw",
    "pay gw alice,carol,bob,dan,A1,A2,A3,A4,A5,A6,A7,A8,A9 30000USD",
    "pay gw alice,carol,bob,dan 30000EUR",
    "pay gw alice,carol,bob,dan 30000GBP",
    "pay gw alice,carol,bob,dan 30000BTC",

    "#",
    "# create",
    "#",
    "amm create alice 10000XRP 10000USD",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 0",
    "expect amm ammXRP-USD none",

    "amm create alice 20000USD 0.5BTC",
    "expect amm 20000USD 0.5BTC 100",
    "amm withdraw alice ammUSD-BTC 0",
    "expect amm ammUSD-BTC none",

    "#",
    "# deposit",
    "#",
    "# equal deposit tokens",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 1000000",
    "expect amm 11000XRP 11000USD 11000000",
    "amm withdraw alice ammXRP-USD 0",
    "expect amm ammXRP-USD none",

    "# equal limit deposit assets",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 100XRP 100USD",
    "expect amm 10100XRP 10100USD 10100000",
    "amm withdraw alice ammXRP-USD 0",

    "# equal limit deposit assets",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 100XRP 200USD",
    "expect amm 10100XRP 10100USD 10100000",
    "amm withdraw alice ammXRP-USD 0",

    "# single deposit USD",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 1000USD",
    "expect amm 10000XRP 11000USD 10488088.48170152",
    "amm withdraw alice ammXRP-USD 0",

    "# single deposit XRP",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 1000XRP",
    "expect amm 11000XRP 10000USD 10488088.48170152",
    "amm withdraw alice ammXRP-USD 0",

    "# single deposit 100000 tokens worth of USD",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 0USD 100000",
    "expect amm 10000XRP 10201USD 10100000",
    "amm withdraw alice ammXRP-USD 0",

    "# single deposit 100000 tokens worth of XRP",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 0XRP 100000",
    "expect amm 10201XRP 10000USD 10100000",
    "amm withdraw alice ammXRP-USD 0",

    "# single deposit with EP not exceeding specified",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 1000USD @0.1USD",
    "expect amm 10000XRP 11000USD 10488088.48170152",
    "amm withdraw alice ammXRP-USD 0",

    "# single deposit with EP not exceeding specified",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 100USD @0.002004USD",
    "expect amm 10000XRP 10080.16USD 10040000",
    "amm withdraw alice ammXRP-USD 0",

    "# single deposit with EP not exceeding specified",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 0USD @0.002004USD",
    "expect amm 10000XRP 10080.16USD 10040000",
    "amm withdraw alice ammXRP-USD 0",

    "#",
    "# withdrawal",
    "#",
    "# equal withdrawal LP tokens",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000000",
    "expect amm 11000XRP 11000USD 11000000",
    "expect amm ammXRP-USD carol 1000000",
    "amm withdraw carol ammXRP-USD 1000000",
    "expect amm ammXRP-USD carol 0",
    "amm withdraw alice ammXRP-USD 0",

    "# equal withdrawal 10% tokens",
    "amm create alice 10000XRP 10000USD",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 1000000",
    "expect amm 9000XRP 9000USD 9000000",
    "amm withdraw alice ammXRP-USD 0",

    "# equal withdrawal with a limit",
    "amm create alice 10000XRP 10000USD",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 200XRP 100USD",
    "expect amm 9900XRP 9900USD 9900000",
    "amm withdraw alice ammXRP-USD 0",

    "# equal withdrawal with a limit",
    "amm create alice 10000XRP 10000USD",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 100XRP 200USD",
    "expect amm 9900XRP 9900USD 9900000",
    "amm withdraw alice ammXRP-USD 0",

    "# single withdrawal by amount",
    "amm create alice 10000XRP 10000USD",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 1000XRP",
    "expect amm 9000XRP 10000USD 9486832.98050514",
    "amm withdraw alice ammXRP-USD 0",

    "# single withdrawal by tokens",
    "amm create alice 10000XRP 10000USD",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 0USD 10000",
    "expect amm 10000XRP 9980.01USD 9990000",
    "amm withdraw alice ammXRP-USD 0",

    "# single deposit USD, withdraw all tokens in USD",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000USD",
    "amm withdraw carol ammXRP-USD 0USD 0",
    "# note USD different due to round-off",
    "expect amm 10000XRP 9999.99999999999USD 10000000",
    "amm withdraw alice ammXRP-USD 0",

    "# single deposit XRP, withdraw all tokens in XRP",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000USD",
    "amm withdraw carol ammXRP-USD 0XRP 0",
    "expect amm 9090909091XRPD 11000USD 10000000",
    "amm withdraw alice ammXRP-USD 0",

    "# equal deposit 10%, withdraw all tokens",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 100000",
    "amm withdraw carol ammXRP-USD 0",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 0",

    "# equal deposit 10%, withdraw all tokens in USD",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 100000",
    "amm withdraw carol ammXRP-USD 0USD 0",
    "expect amm 10100XRP 9900.990099009901USD 10000000",
    "amm withdraw alice ammXRP-USD 0",

    "# equal deposit 10%, withdraw all tokens in XRP",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 100000",
    "amm withdraw carol ammXRP-USD 0XRP 0",
    "expect amm 9900990099XRPD 10100USD 10000000",
    "amm withdraw alice ammXRP-USD 0",

    "# withdraw with eprice limit",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000000",
    "amm withdraw carol ammXRP-USD 100USD @520",
    "expect amm 11000XRP 9372.781065088757USD 10153846.15384615",
    "amm withdraw carol ammXRP-USD 0",
    "amm withdraw alice ammXRP-USD 0",

    "# withdraw with eprice limit",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000000",
    "amm withdraw carol ammXRP-USD 0USD @520",
    "expect amm 11000XRP 9372.781065088757USD 10153846.15384615",
    "amm withdraw carol ammXRP-USD 0",
    "amm withdraw alice ammXRP-USD 0",

    "#",
    "# voting",
    "#",
    "# one vote sets fee to 1%",
    "amm create alice 10000XRP 10000USD",
    "amm vote alice ammXRP-USD 1000",
    "expect fee ammXRP-USD 1000",
    "amm withdraw alice ammXRP-USD 0",

    "# eight votes fill all voting slots, set fee to 0.225%",
    "amm create alice 10000XRP 10000USD",
    "repeat 1 8 amm deposit A$i ammXRP-USD 10000",
    "repeat 1 8 amm vote A$i ammXRP-USD (50*$i)",
    "expect fee ammXRP-USD 225",
    "repeat 1 8 amm withdraw A$i ammXRP-USD 0",
    "amm withdraw alice ammXRP-USD 0",

    "# eight votes fill all voting slots, set fee to 0.225%",
    "# new vote, same account sets fee 0.275%",
    "amm create alice 10000XRP 10000USD",
    "repeat 1 8 amm deposit A$i ammXRP-USD 10000",
    "repeat 1 8 amm vote A$i ammXRP-USD (50*$i)",
    "expect fee ammXRP-USD 225",
    "amm vote A1 ammXRP-USD 450",
    "expect fee ammXRP-USD 275",
    "repeat 1 8 amm withdraw A$i ammXRP-USD 0",
    "amm withdraw alice ammXRP-USD 0",

    "# eight votes fill all voting slots, set fee to 0.225%",
    "# new vote, new account higher vote weight sets fee 0.294%",
    "amm create alice 10000XRP 10000USD",
    "repeat 1 8 amm deposit A$i ammXRP-USD 10000",
    "repeat 1 8 amm vote A$i ammXRP-USD (50*$i)",
    "expect fee ammXRP-USD 225",
    "amm deposit A9 ammXRP-USD 200",
    "amm vote A9 ammXRP-USD 45",
    "expect fee ammXRP-USD 294",
    "repeat 1 9 amm withdraw A$i ammXRP-USD 0",
    "amm withdraw alice ammXRP-USD 0",

    "# eight votes fill all voting slots, set fee to 0.275%",
    "# new vote, new account higher vote weight sets fee 0.244%",
    "amm create alice 10000XRP 10000USD",
    "repeat 2 9 amm deposit A$i ammXRP-USD 10000",
    "repeat 2 9 amm vote A$i ammXRP-USD (50*$i)",
    "expect fee ammXRP-USD 275",
    "amm deposit A1 ammXRP-USD 200",
    "amm vote A1 ammXRP-USD 50",
    "expect fee ammXRP-USD 244",
    "repeat 1 9 amm withdraw A$i ammXRP-USD 0",
    "amm withdraw alice ammXRP-USD 0",

    "#",
    "# bidding",
    "#",
    "# bid 100 tokens. the slot is not owned, min slot price is 110",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000000",
    "amm bid carol ammXRP-USD min 100",
    "expect auction ammXRP-USD 0 0 110",
    "amm withdraw carol ammXRP-USD 0",
    "amm withdraw alice ammXRP-USD 0",

    "# start bid at computed price. the slot is not owned and min slot price is 110",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000000",
    "amm bid carol ammXRP-USD min 0",
    "expect auction ammXRP-USD 0 0 110",
    "amm deposit bob ammXRP-USD 1000000",
    "# bid, pay the computed price",
    "amm bid bob ammXRP-USD min 0",
    "expect auction ammXRP-USD 0 0 115.5",
    "amm bid bob ammXRP-USD max 135",
    "expect auction ammXRP-USD 0 0 135",
    "amm withdraw bob ammXRP-USD 0",
    "amm withdraw carol ammXRP-USD 0",
    "amm withdraw alice ammXRP-USD 0",

    "#",
    "# payment",
    "#",
    "# partial payment ~99USD for 100XRP",
    "# force one path with tfNoRippleDirect",
    "amm create alice 10000XRP 10000USD",
    "pay bob carol 100USD [[USD]] 100XRP partialPayment,noRippleDirect",
    "expect amm 10100XRP 9900.990099009901USD 10000000",
    "amm withdraw alice ammXRP-USD 0",

    "# partial payment ~99USD for 100XRP, use default path",
    "amm create alice 10000XRP 10000USD",
    "pay bob carol 100USD [] 100XRP partialPayment",
    "expect amm 10100XRP 9900.990099009901USD 10000000",
    "amm withdraw alice ammXRP-USD 0",

    "# non-default path (AMM) has a better quality than default path",
    "# the max possible liquidity is taken out of non-default path",
    "# ~17.5XRP/17.5EUR, 17.5EUR/~17.47USD, the rest is taken from offer",
    "amm create alice 10000XRP 10000EUR",
    "amm create alice 10000EUR 10000USD",
    "offer create alice 101XRP 100USD passive",
    "pay bob carol 100USD [[EUR,USD]] 102XRP partialPayment",
    "expect amm 10017526291XRPD 9982.504373906523EUR 10000000",
    "expect amm 9982.534949910292USD 10017.49562609347EUR 10000",
    "expect offers alice {17639700XRPD,17.46505008970784USD}",
    "amm withdraw alice ammXRP-EUR 0",
    "amm withdraw alice ammEUR-USD 0",
    "offer cancel alice",

    "# default path (AMM) has a better quality than a non-default path",
    "# max possible liquidity is taken out of default path ~17.5XRP/17.5USD",
    "# the rest is taken from the offer.",
    "amm create alice 10000XRP 10000USD",
    "offer create alice 101XRP 100EUR passive",
    "offer create alice 100EUR 100USD passive",
    "pay bob carol 100USD [[EUR,USD]] 102XRP partialPayment",
    "expect amm 10017526291XRPD 9982.504373906523USD 10000000",
    "expect offers alice {17670582XRPD,17.495626093477EUR},{17.495626093477EUR,17.495626093477USD}",
    "amm withdraw alice ammXRP-USD 0",
    "offer cancel alice",

    "# Default path with AMM and Order Book offer. AMM is consumed first",
    "# remaining amount is consumed by the offer.",
    "amm create alice 9900XRP 10100USD",
    "offer create bob 100XRP 100USD",
    "pay alice carol 200USD [] 200XRP partialPayment",
    "expect amm 9999499988XRPD 9999.499987998748USD 9999499.98749938",
    "expect offers bob {500013XRPD,0.50001300125USD}",
    "amm withdraw alice ammXRP-USD 0",
    "offer cancel alice",

    "# offer crossing XRP/IOU",
    "amm create alice 9900XRP 10100USD",
    "offer create bob 100USD 100XRP",
    "expect amm 9999XRP 10000USD 9999499.98749938",
    "expect offers bob",
    "amm withdraw alice ammXRP-USD 0",
    "offer cancel bob",

    "# offer crossing IOU/IOU",
    "amm create alice 9900EUR 10100USD",
    "offer create bob 100USD 100EUR",
    "expect amm 9999.000000000004EUR 10000USD 9999.49998749938",
    "expect offers bob",
    "amm withdraw alice ammEUR-USD 0",
    "offer cancel bob",

    "#",
    "# Use AMM tokens",
    "# AMM with one LPToken from another AMM",
    "amm create amm1 alice 10000XRP 10000USD",
    "amm create amm2 alice 10000EUR 1000000$amm1",
    "expect amm 10000EUR 1000000$amm1 100000",
    "amm withdraw alice amm2 0",
    "amm withdraw alice amm1 0",

    "# AMM with two LPToken from other AMMs",
    "amm create amm1 alice 10000XRP 10000USD",
    "amm create amm2 alice 10000XRP 10000EUR",
    "amm create amm3 alice 1000000$amm1 1000000$amm2",
    "expect amm 1000000$amm1 1000000$amm2 1000000",
    "amm withdraw alice amm3 0",
    "amm withdraw alice amm2 0",
    "amm withdraw alice amm1 0",

    "# AMM with two LPToken from other AMMs",
    "# LP deposits/withdraws",
    "amm create amm1 alice 10000XRP 10000USD",
    "amm create amm2 alice 10000XRP 10000EUR",
    "amm create amm3 alice 1000000$amm1 1000000$amm2",
    "expect amm 1000000$amm1 1000000$amm2 1000000",
    "amm deposit alice amm3 10000",
    "amm withdraw alice amm3 10000",
    "expect amm 1000000$amm1 1000000$amm2 1000000",
    "amm withdraw alice amm3 0",
    "amm withdraw alice amm2 0",
    "amm withdraw alice amm1 0",

    "# offer crossing with two AMM LPToken",
    "amm create amm1 alice 10000XRP 10000USD",
    "amm deposit carol amm1 1000000",
    "amm create amm2 alice 10000XRP 10000EUR",
    "amm deposit carol amm2 1000000",
    "offer create alice 100$amm1 100$amm2",
    "expect offers alice {100$amm1,100$amm2}",
    "get line alice $amm1 alice_t1",
    "get line alice $amm2 alice_t2",
    "get line carol $amm1 carol_t1",
    "get line carol $amm2 carol_t2",
    "offer create carol 100$amm2 100$amm1",
    "expect offers alice",
    "expect offers carol",
    "expect line alice ($alice_t1+100)",
    "expect line alice ($alice_t2-100)",
    "expect line carol ($carol_t2+100)",
    "expect line carol ($carol_t1-100)",
    "amm withdraw carol amm1 0",
    "amm withdraw carol amm2 0",
    "amm withdraw alice amm1 0",
    "amm withdraw alice amm2 0",

    "# offer crossing with two AMM LPToken via AMM",
    "amm create amm1 alice 10000XRP 10000USD",
    "amm deposit carol amm1 1000000",
    "amm create amm2 alice 10000XRP 10000EUR",
    "amm deposit carol amm2 1000000",
    "amm create amm3 alice 9900$amm1 10100$amm2",
    "get line carol $amm1 carol_t1",
    "get line carol $amm2 carol_t2",
    "offer create carol 100$amm2 100$amm1",
    "expect offers carol",
    "expect amm 9999.000000000004$amm1 10000$amm2 9999.49998749938",
    "expect line carol ($carol_t1-99)",
    "expect line carol ($carol_t2+100)",
    "# if amm3 deleted last then amm1 is not deleted",
    "amm withdraw alice amm3 0",
    "amm withdraw carol amm1 0",
    "amm withdraw carol amm2 0",
    "amm withdraw alice amm1 0",
    "amm withdraw alice amm2 0",

    "# LPs pay LPToken directly. Must trust set",
    "amm create amm1 alice 10000XRP 10000USD",
    "trust set carol 2000000$amm1",
    "amm deposit carol amm1 1000000",
    "expect amm amm1 alice 10000000",
    "expect amm amm1 carol 1000000",
    "get line alice $amm1 alice_t1",
    "get line carol $amm1 carol_t1",
    "pay alice carol 100$amm1",
    "# pool balance does not change, tokens moved between the accounts",
    "expect line alice ($alice_t1-100)",
    "expect line carol ($carol_t1+100)",
    "amm withdraw carol amm1 0",
    "amm withdraw alice amm1 0",

    "# AMM with two tokens from another AMM.",
    "# LP pays LPTokens to non-LP via AMM.",
    "# non-LP must trust set for LPTokens.",
    "amm create amm1 alice 10000XRP 10000USD",
    "amm create amm2 alice 10000XRP 10000EUR",
    "amm create amm3 alice 1000000$amm1 1000000$amm2",
    "trust set carol 1000$amm1",
    "pay alice carol 100$amm1 [[$amm1]] 100$amm2 partialPayment,noRippleDirect",
    "expect amm 999900.0099990001$amm1 1000100$amm2 1000000",
    "expect amm amm1 alice 9000000",
    "expect amm amm1 carol 99.9900009999",
    "expect amm amm2 alice 8999900",
    "amm withdraw alice amm3 0",
    "amm withdraw alice amm2 0",
    "amm withdraw alice amm1 0"
]
