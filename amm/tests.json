[
    "# Run this script:./amm_tester.py ./tests.json",
    "# Runs on ammdevnet. Change next line to run on a different net.",
    "set node ammdevnet:51234",
    "#",
    "# fund",
    "#",
    "fund gw,alice,carol,bob,dan,A1,A2,A3,A4,A5,A6,A7,A8,A9 40000XRP",
    "trust set alice,carol,bob,dan,A1,A2,A3,A4,A5,A6,A7,A8,A9 60000USD gw",
    "trust set alice,carol,bob,dan 60000EUR gw",
    "trust set alice,carol,bob,dan 60000GBP gw",
    "trust set alice,carol,bob,dan 60000BTC gw",
    "pay gw alice,carol,bob,dan,A1,A2,A3,A4,A5,A6,A7,A8,A9 30000USD",
    "pay gw alice,carol,bob,dan 30000EUR",
    "pay gw alice,carol,bob,dan 30000GBP",
    "pay gw alice,carol,bob,dan 30000BTC",

    "#",
    "# create",
    "#",
    "amm create alice 10000XRP 10000USD",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",
    "expect amm ammXRP-USD none",

    "amm create alice 20000USD 0.5BTC",
    "expect amm 20000USD 0.5BTC 100",
    "amm withdraw alice ammUSD-BTC 0",
    "wait 6",
    "expect amm ammUSD-BTC none",

    "#",
    "# deposit",
    "#",
    "# equal deposit tokens",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 1000000",
    "wait 6",
    "expect amm 11000XRP 11000USD 11000000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",
    "expect amm ammXRP-USD none",

    "# equal limit deposit assets",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 100XRP 100USD",
    "wait 6",
    "expect amm 10100XRP 10100USD 10100000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# equal limit deposit assets",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 100XRP 200USD",
    "wait 6",
    "expect amm 10100XRP 10100USD 10100000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# single deposit USD",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 1000USD",
    "wait 6",
    "expect amm 10000XRP 11000USD 10488088.48170152",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# single deposit XRP",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 1000XRP",
    "wait 6",
    "expect amm 11000XRP 10000USD 10488088.48170152",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# single deposit 100000 tokens worth of USD",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 0USD 100000",
    "wait 6",
    "expect amm 10000XRP 10201USD 10100000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# single deposit 100000 tokens worth of XRP",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 0XRP 100000",
    "wait 6",
    "expect amm 10201XRP 10000USD 10100000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# single deposit with EP not exceeding specified",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 1000USD @0.1USD",
    "wait 6",
    "expect amm 10000XRP 11000USD 10488088.48170152",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# single deposit with EP not exceeding specified",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 100USD @0.002004USD",
    "wait 6",
    "expect amm 10000XRP 10080.16USD 10040000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# single deposit with EP not exceeding specified",
    "amm create alice 10000XRP 10000USD",
    "amm deposit alice ammXRP-USD 0USD @0.002004USD",
    "wait 6",
    "expect amm 10000XRP 10080.16USD 10040000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "#",
    "# withdrawal",
    "#",
    "# equal withdrawal LP tokens",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000000",
    "wait 6",
    "expect amm 11000XRP 11000USD 11000000",
    "expect amm carol @ammXRP-USD 1000000",
    "amm withdraw carol ammXRP-USD 1000000",
    "wait 6",
    "expect amm carol @ammXRP-USD 0",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# equal withdrawal 10% tokens",
    "amm create alice 10000XRP 10000USD",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 1000000",
    "wait 6",
    "expect amm 9000XRP 9000USD 9000000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# equal withdrawal with a limit",
    "amm create alice 10000XRP 10000USD",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 200XRP 100USD",
    "wait 6",
    "expect amm 9900XRP 9900USD 9900000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# equal withdrawal with a limit",
    "amm create alice 10000XRP 10000USD",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 100XRP 200USD",
    "wait 6",
    "expect amm 9900XRP 9900USD 9900000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# single withdrawal by amount",
    "amm create alice 10000XRP 10000USD",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 1000XRP",
    "wait 6",
    "expect amm 9000XRP 10000USD 9486832.98050514",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# single withdrawal by tokens",
    "amm create alice 10000XRP 10000USD",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 0USD 10000",
    "wait 6",
    "expect amm 10000XRP 9980.01USD 9990000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# single deposit USD, withdraw all tokens in USD",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000USD",
    "wait 6",
    "amm withdraw carol ammXRP-USD 0USD 0",
    "wait 6",
    "# note USD different due to round-off",
    "expect amm 10000XRP 9999.99999999999USD 10000000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# single deposit XRP, withdraw all tokens in XRP",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000USD",
    "wait 6",
    "amm withdraw carol ammXRP-USD 0XRP 0",
    "wait 6",
    "expect amm 9090909091XRPD 11000USD 10000000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# equal deposit 10%, withdraw all tokens",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 100000",
    "wait 6",
    "amm withdraw carol ammXRP-USD 0",
    "wait 6",
    "expect amm 10000XRP 10000USD 10000000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# equal deposit 10%, withdraw all tokens in USD",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 100000",
    "wait 6",
    "amm withdraw carol ammXRP-USD 0USD 0",
    "wait 6",
    "expect amm 10100XRP 9900.990099009901USD 10000000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# equal deposit 10%, withdraw all tokens in XRP",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 100000",
    "wait 6",
    "amm withdraw carol ammXRP-USD 0XRP 0",
    "wait 6",
    "expect amm 9900990099XRPD 10100USD 10000000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# withdraw with eprice limit",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000000",
    "wait 6",
    "amm withdraw carol ammXRP-USD 100USD @520",
    "wait 6",
    "expect amm 11000XRP 9372.781065088756USD 10153846.15384615",
    "amm withdraw carol ammXRP-USD 0",
    "wait 6",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# withdraw with eprice limit",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000000",
    "wait 6",
    "amm withdraw carol ammXRP-USD 0USD @520",
    "wait 6",
    "expect amm 11000XRP 9372.781065088756USD 10153846.15384615",
    "amm withdraw carol ammXRP-USD 0",
    "wait 6",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "#",
    "# voting",
    "#",
    "# one vote sets fee to 1%",
    "amm create alice 10000XRP 10000USD",
    "amm vote alice ammXRP-USD 1000",
    "wait 6",
    "expect fee ammXRP-USD 1000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# eight votes fill all voting slots, set fee to 2%",
    "amm create alice 10000XRP 10000USD",
    "repeat 1 8 amm deposit A$i ammXRP-USD 10000",
    "wait 6",
    "repeat 1 8 amm vote A$i ammXRP-USD #500*$i#",
    "wait 6",
    "expect fee ammXRP-USD 2250",
    "repeat 1 8 amm withdraw A$i ammXRP-USD 0",
    "wait 6",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# eight votes fill all voting slots, set fee to 2%",
    "# new vote, same account sets fee 2.75%",
    "amm create alice 10000XRP 10000USD",
    "repeat 1 8 amm deposit A$i ammXRP-USD 10000",
    "wait 6",
    "repeat 1 8 amm vote A$i ammXRP-USD #500*$i#",
    "wait 6",
    "expect fee ammXRP-USD 2250",
    "amm vote A1 ammXRP-USD 4500",
    "wait 6",
    "expect fee ammXRP-USD 2750",
    "repeat 1 8 amm withdraw A$i ammXRP-USD 0",
    "wait 6",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# eight votes fill all voting slots, set fee to 2.25%",
    "# new vote, new account higher vote weight sets fee 2.945%",
    "amm create alice 10000XRP 10000USD",
    "repeat 1 8 amm deposit A$i ammXRP-USD 10000",
    "wait 6",
    "repeat 1 8 amm vote A$i ammXRP-USD #500*$i#",
    "wait 6",
    "expect fee ammXRP-USD 2250",
    "amm deposit A9 ammXRP-USD 20000",
    "wait 6",
    "amm vote A9 ammXRP-USD 4500",
    "wait 6",
    "expect fee ammXRP-USD 2945",
    "repeat 1 9 amm withdraw A$i ammXRP-USD 0",
    "wait 6",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# eight votes fill all voting slots, set fee to 2.75%",
    "# new vote, new account higher vote weight sets fee 2.056%",
    "amm create alice 10000XRP 10000USD",
    "repeat 2 9 amm deposit A$i ammXRP-USD 10000",
    "wait 6",
    "repeat 2 9 amm vote A$i ammXRP-USD #500*$i#",
    "wait 6",
    "expect fee ammXRP-USD 2750",
    "amm deposit A1 ammXRP-USD 20000",
    "wait 6",
    "amm vote A1 ammXRP-USD 500",
    "wait 6",
    "# TODO, update to the latest amm rippled",
    "#expect fee ammXRP-USD 2445",
    "repeat 1 9 amm withdraw A$i ammXRP-USD 0",
    "wait 6",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "#",
    "# bidding",
    "#",
    "# bid 100 tokens. the slot is not owned, min slot price is 110",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000000",
    "wait 6",
    "amm bid carol ammXRP-USD min 100",
    "wait 6",
    "expect auction ammXRP-USD 0 0 110",
    "amm withdraw carol ammXRP-USD 0",
    "wait 6",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# start bid at computed price. the slot is not owned and min slot price is 110",
    "amm create alice 10000XRP 10000USD",
    "amm deposit carol ammXRP-USD 1000000",
    "wait 6",
    "amm bid carol ammXRP-USD min 0",
    "wait 6",
    "expect auction ammXRP-USD 0 0 110",
    "amm deposit bob ammXRP-USD 1000000",
    "# bid, pay the computed price",
    "amm bid bob ammXRP-USD min 0",
    "wait 6",
    "expect auction ammXRP-USD 0 0 115.5",
    "amm bid bob ammXRP-USD max 135",
    "wait 6",
    "expect auction ammXRP-USD 0 0 135",
    "amm withdraw bob ammXRP-USD 0",
    "wait 6",
    "amm withdraw carol ammXRP-USD 0",
    "wait 6",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "#",
    "# payment",
    "#",
    "# partial payment ~99USD for 100XRP",
    "# force one path with tfNoRippleDirect",
    "amm create alice 10000XRP 10000USD",
    "pay bob carol 100USD [[USD]] 100XRP partialPayment,noRippleDirect",
    "wait 6",
    "expect amm 10100XRP 9900.990099009901USD 10000000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# partial payment ~99USD for 100XRP, use default path",
    "amm create alice 10000XRP 10000USD",
    "pay bob carol 100USD [] 100XRP partialPayment",
    "wait 6",
    "expect amm 10100XRP 9900.990099009901USD 10000000",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",

    "# non-default path (AMM) has a better quality than default path",
    "# the max possible liquidity is taken out of non-default path",
    "# ~17.5XRP/17.5EUR, 17.5EUR/~17.47USD, the rest is taken from offer",
    "amm create alice 10000XRP 10000EUR",
    "amm create alice 10000EUR 10000USD",
    "offer create alice 101XRP 100USD passive",
    "wait 6",
    "pay bob carol 100USD [[EUR,USD]] 102XRP partialPayment",
    "wait 6",
    "expect amm 10017526291XRPD 9982.504373906523EUR 10000000",
    "expect amm 9982.534949910309USD 10017.49562609347EUR 10000",
    "expect offers alice {17639700XRPD,17.46505008969044USD}",
    "amm withdraw alice ammXRP-EUR 0",
    "wait 6",
    "amm withdraw alice ammEUR-USD 0",
    "wait 6",
    "offer cancel alice",
    "wait 6",

    "# default path (AMM) has a better quality than a non-default path",
    "# max possible liquidity is taken out of default path ~17.5XRP/17.5USD",
    "# the rest is taken from the offer.",
    "amm create alice 10000XRP 10000USD",
    "offer create alice 101XRP 100EUR passive",
    "wait 6",
    "offer create alice 100EUR 100USD passive",
    "wait 6",
    "pay bob carol 100USD [[EUR,USD]] 102XRP partialPayment",
    "wait 6",
    "expect amm 10017526291XRPD 9982.504373906523USD 10000000",
    "expect offers alice {17670582XRPD,17.495626093477EUR},{17.495626093477EUR,17.495626093477USD}",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",
    "offer cancel alice",
    "wait 6",

    "# Default path with AMM and Order Book offer. AMM is consumed first",
    "# remaining amount is consumed by the offer.",
    "amm create alice 9900XRP 10100USD",
    "offer create bob 100XRP 100USD",
    "wait 6",
    "pay alice carol 200USD [] 200XRP partialPayment",
    "wait 6",
    "expect amm 9999499987XRPD 9999.499987998749USD 9999499.98749938",
    "expect offers bob {500012XRPD,0.5000120012508USD}",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",
    "offer cancel alice",
    "wait 6",

    "# offer crossing XRP/IOU",
    "amm create alice 9900XRP 10100USD",
    "offer create bob 100USD 100XRP",
    "wait 6",
    "expect amm 9999XRP 10000USD 9999499.98749938",
    "expect offers bob",
    "amm withdraw alice ammXRP-USD 0",
    "wait 6",
    "offer cancel bob",
    "wait 6",

    "# offer crossing IOU/IOU",
    "amm create alice 9900EUR 10100USD",
    "offer create bob 100USD 100EUR",
    "wait 6",
    "expect amm 9999EUR 10000USD 9999.49998749938",
    "expect offers bob 0",
    "amm withdraw alice ammEUR-USD 0",
    "wait 6",
    "offer cancel bob",
    "wait 6"
]

